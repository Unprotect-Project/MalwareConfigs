{******************************************************************************}
{                                                                              }
{                                                                              }
{                   Author: DarkCoderSc (Jean-Pierre LESUEUR)                  }
{                   https://www.twitter.com/darkcodersc                        }
{                   https://www.unprotect.it/                                  }
{                   https://github.com/Unprotect-Project                       }
{                   https://github.com/darkcodersc                             }
{                   https://github.com/PhrozenIO                               }
{                   License: Apache License 2.0                                }
{                                                                              }
{                                                                              }
{******************************************************************************}

program Builder;

{$APPTYPE CONSOLE}

{$R *.res}

uses
  Winapi.Windows,
  System.SysUtils,
  uExceptions in '..\..\..\Shared\Delphi\uExceptions.pas',
  uPayload in '..\..\..\Shared\Delphi\uPayload.pas',
  uSharedFunctions in '..\..\..\Shared\Delphi\uSharedFunctions.pas';


const RES_NAME = 'MALZCONF';

var AConfig   : TMalwareConfig;
    hResource : THandle;
    AStubFile : String;

begin
  try
    { Open Target Stub }
    if not OpenFileDialog(AStubFile) then
      ExitProcess(1);

    WriteLn(Format('Working on [%s] stub.', [AStubFile]));

    { Prepare Config Payload }
    PromptPayloadConfiguration(AConfig);

    WriteLn('Write configuration to stub "RT_RCDATA"...');

    // https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-beginupdateresourcew?WT_mc_id=SEC-MVP-5005282
    hResource := BeginUpdateResourceW(PWideChar(AStubFile), True);
    if hResource = 0 then
      raise EWindowsException.Create('BeginUpdateResourceW');
    try
      // https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-updateresourcew?WT_mc_id=SEC-MVP-5005282
      if not UpdateResourceW(hResource, RT_RCDATA, RES_NAME, 0, @AConfig, SizeOf(TMalwareConfig)) then
        raise EWindowsException.Create('UpdateResourceW');
    finally
      // https://learn.microsoft.com/fr-fr/windows/win32/api/winbase/nf-winbase-endupdateresourcew?WT_mc_id=SEC-MVP-5005282
      if not EndUpdateResourceW(hResource, False) then
        raise EWindowsException.Create('EndUpdateResourceW');
    end;

    WriteLn('Done');

    ///
    WriteLn('Press return key to exit.');
    readln;
  except
    on E: Exception do
      Writeln(E.ClassName, ': ', E.Message);
  end;
end.
